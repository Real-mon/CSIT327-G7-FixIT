{% extends "base.html" %}

{% block title %}Technician Directory - FixIT{% endblock %}

{% block content %}
<!-- Animated Background -->
<div class="absolute inset-0 overflow-hidden">
    <div class="absolute -inset-10 opacity-20">
        <div class="absolute top-1/3 left-1/4 w-96 h-96 bg-gradient-to-r from-[#8fbaf3] to-[#0245a3] rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse"></div>
        <div class="absolute bottom-1/3 right-1/4 w-96 h-96 bg-gradient-to-r from-[#bdf1f6] to-[#8fbaf3] rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse animation-delay-2000"></div>
    </div>
</div>

<div class="relative min-h-screen">
    <div class="flex">
        <!-- Sidebar -->
        <div class="w-64 bg-white/20 backdrop-blur-lg border-r border-[#8fbaf3]/40 min-h-screen p-6">
            <!-- Logo -->
            <div class="flex items-center space-x-3 mb-8">
                <div class="w-10 h-10 bg-gradient-to-r from-[#8fbaf3] to-[#0245a3] rounded-xl flex items-center justify-center">
                    <i class="fas fa-tools text-[#0245a3]"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-[#0245a3]">FixIT</h1>
                    <p class="text-xs text-[#0245a3]">Support Portal</p>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="space-y-2">
                <a href="{% url 'dashboard' %}" class="flex items-center space-x-3 text-[#0245a3] hover:bg-white/20 rounded-xl px-4 py-3 transition">
                    <i class="fas fa-home w-5"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{% url 'my_tickets' %}" class="flex items-center space-x-3 text-[#0245a3] hover:bg-white/20 rounded-xl px-4 py-3 transition">
                    <i class="fas fa-ticket-alt w-5"></i>
                    <span>My Tickets</span>
                </a>
                <a href="{% url 'technician_directory' %}" class="flex items-center space-x-3 bg-white/20 text-[#0245a3] font-semibold rounded-xl px-4 py-3">
                    <i class="fas fa-user-cog w-5"></i>
                    <span>Technicians</span>
                </a>
                <a href="{% url 'user_message' %}" class="flex items-center space-x-3 text-[#0245a3] hover:bg-white/20 rounded-xl px-4 py-3 transition">
                    <i class="fas fa-comments w-5"></i>
                    <span>Messages</span>
                </a>
                <a href="{% url 'user_profile' %}" class="flex items-center space-x-3 text-[#0245a3] hover:bg-white/20 rounded-xl px-4 py-3 transition">
                    <i class="fas fa-user w-5"></i>
                    <span>My Profile</span>
                </a>
                <!-- Settings -->
                <a href="{% url 'settings' %}" class="flex items-center space-x-3 text-[#0245a3] hover:bg-white/20 rounded-xl px-4 py-3 transition">
                    <i class="fas fa-cog w-5"></i>
                    <span>Settings</span>
                </a>
                <a href="{% url 'logout' %}" class="flex items-center space-x-3 text-[#0245a3] hover:bg-white/20 rounded-xl px-4 py-3 transition">
                    <i class="fas fa-sign-out-alt w-5"></i>
                    <span>Logout</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-[#0245a3] mb-2">Technician Directory</h1>
                <p class="text-[#0245a3]">Find the right technician for your needs from our certified professionals</p>
            </div>

            <!-- Search and Filter Section -->
            <div class="bg-white/20 backdrop-blur-lg rounded-2xl border border-[#8fbaf3]/40 p-6 mb-8">
                <form method="GET" action="{% url 'technician_directory' %}" class="flex flex-col md:flex-row gap-4">
                    <!-- Search -->
                    <div class="flex-1">
                        <div class="relative">
                            <input type="text"
                                   name="search"
                                   placeholder="Search technicians by name, specialty, or bio..."
                                   value="{{ search_query }}"
                                   class="w-full bg-white/30 border border-[#8fbaf3]/40 rounded-xl py-3 px-4 text-[#0245a3] placeholder-[#0245a3]/60 focus:outline-none focus:ring-2 focus:ring-[#0245a3]">
                            <i class="fas fa-search absolute right-3 top-3 text-[#0245a3]"></i>
                        </div>
                    </div>

                    <!-- Filter by Service -->
                    <div class="md:w-48">
                        <select name="service" class="w-full bg-white/30 border border-[#8fbaf3]/40 rounded-xl py-3 px-4 text-[#0245a3] focus:outline-none focus:ring-2 focus:ring-[#0245a3]">
                            <option value="">All Specialties</option>
                            {% for specialty in all_specialties %}
                            <option value="{{ specialty.name }}" {% if selected_service == specialty.name %}selected{% endif %}>
                                {{ specialty.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filter by Availability -->
                    <div class="md:w-40">
                        <select name="availability" class="w-full bg-white/30 border border-[#8fbaf3]/40 rounded-xl py-3 px-4 text-[#0245a3] focus:outline-none focus:ring-2 focus:ring-[#0245a3]">
                            <option value="">All Status</option>
                            <option value="available" {% if selected_availability == 'available' %}selected{% endif %}>Available</option>
                            <option value="busy" {% if selected_availability == 'busy' %}selected{% endif %}>Busy</option>
                        </select>
                    </div>

                    <!-- Sort Options -->
                    <div class="md:w-48">
                        <select name="sort" class="w-full bg-white/30 border border-[#8fbaf3]/40 rounded-xl py-3 px-4 text-[#0245a3] focus:outline-none focus:ring-2 focus:ring-[#0245a3]">
                            <option value="rating" {% if selected_sort == 'rating' %}selected{% endif %}>Highest Rated</option>
                            <option value="name" {% if selected_sort == 'name' %}selected{% endif %}>Name A-Z</option>
                            <option value="experience" {% if selected_sort == 'experience' %}selected{% endif %}>Most Experienced</option>
                            <option value="response_time" {% if selected_sort == 'response_time' %}selected{% endif %}>Fastest Response</option>
                        </select>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="md:w-auto bg-gradient-to-r from-[#8fbaf3] to-[#0245a3] text-white font-semibold rounded-xl px-6 py-3 hover:opacity-90 transition">
                        Apply Filters
                    </button>
                </form>
            </div>

            <!-- Statistics Bar -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white/20 backdrop-blur-lg rounded-xl border border-[#8fbaf3]/40 p-4 text-center">
                    <div class="text-2xl font-bold text-[#0245a3]">{{ technicians|length }}</div>
                    <div class="text-sm text-[#0245a3]">Total Technicians</div>
                </div>
                <div class="bg-white/20 backdrop-blur-lg rounded-xl border border-[#8fbaf3]/40 p-4 text-center">
                    <div class="text-2xl font-bold text-[#0245a3]">
                        {{ technicians|length|default:0 }}
                    </div>
                    <div class="text-sm text-[#0245a3]">Available Now</div>
                </div>
                <div class="bg-white/20 backdrop-blur-lg rounded-xl border border-[#8fbaf3]/40 p-4 text-center">
                    <div class="text-2xl font-bold text-[#0245a3]">
                        {% if technicians %}{{ technicians.0.rating|floatformat:1 }}{% else %}4.5{% endif %}+
                    </div>
                    <div class="text-sm text-[#0245a3]">Average Rating</div>
                </div>
                <div class="bg-white/20 backdrop-blur-lg rounded-xl border border-[#8fbaf3]/40 p-4 text-center">
                    <div class="text-2xl font-bold text-[#0245a3]">{{ all_specialties|length }}+</div>
                    <div class="text-sm text-[#0245a3]">Specialties</div>
                </div>
            </div>

            <!-- Technician Cards Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for tech in technicians %}
                <div class="bg-white/20 backdrop-blur-lg rounded-2xl border border-[#8fbaf3]/40 p-6 hover:shadow-lg transition-all duration-300">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            {% if tech.profile_picture_url %}
                            <img src="{{ tech.profile_picture_url }}" alt="{{ tech.first_name }} {{ tech.last_name }}"
                                 class="w-16 h-16 rounded-full object-cover border-2 border-[#8fbaf3]">
                            {% else %}
                            <div class="w-16 h-16 bg-gradient-to-r from-[#8fbaf3] to-[#0245a3] rounded-full flex items-center justify-center text-white font-bold text-lg border-2 border-[#8fbaf3]">
                                {{ tech.initials }}
                            </div>
                            {% endif %}
                            <div>
                                <h3 class="font-bold text-[#0245a3] text-lg">
                                    {{ tech.first_name|default:tech.username }} {{ tech.last_name|default:"" }}
                                </h3>
                                <div class="flex items-center mt-1">
                                    <div class="flex text-yellow-400">
                                        {% with ''|center:5 as range %}
                                        {% for i in range %}
                                            {% if forloop.counter <= tech.rating|add:"0" %}
                                                <i class="fas fa-star text-sm"></i>
                                            {% elif forloop.counter <= tech.rating|add:"0.5" %}
                                                <i class="fas fa-star-half-alt text-sm"></i>
                                            {% else %}
                                                <i class="far fa-star text-sm"></i>
                                            {% endif %}
                                        {% endfor %}
                                        {% endwith %}
                                    </div>
                                    <span class="ml-2 text-[#0245a3] text-sm">{{ tech.rating|floatformat:1 }} ({{ tech.review_count }})</span>
                                </div>
                            </div>
                        </div>
                        <div class="{{ tech.availability_class }} text-xs font-semibold px-2 py-1 rounded-full">
                            {{ tech.availability_status }}
                        </div>
                    </div>

                    <!-- Bio -->
                    {% if tech.bio %}
                    <div class="mb-4">
                        <p class="text-[#0245a3] text-sm line-clamp-2">{{ tech.bio|truncatewords:20 }}</p>
                    </div>
                    {% endif %}

                    <div class="mb-4">
                        <h4 class="text-[#0245a3] font-semibold mb-2">Specialties</h4>
                        <div class="flex flex-wrap gap-2">
                            {% for specialty in tech.specialties %}
                            <span class="bg-[#8fbaf3]/30 text-[#0245a3] text-xs px-3 py-1 rounded-full">{{ specialty }}</span>
                            {% empty %}
                            <span class="bg-[#8fbaf3]/30 text-[#0245a3] text-xs px-3 py-1 rounded-full">General IT Support</span>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Additional Info -->
                    <div class="space-y-2 text-sm text-[#0245a3] mb-4">
                        <div class="flex justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-briefcase mr-2"></i>
                                <span>{{ tech.experience_years }} year{{ tech.experience_years|pluralize }} exp.</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-clock mr-2"></i>
                                <span>{{ tech.response_time }}h avg.</span>
                            </div>
                        </div>
                        <div class="flex justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>
                                <span>{{ tech.completed_tickets }} completed</span>
                            </div>
                            {% if tech.hourly_rate %}
                            <div class="flex items-center">
                                <i class="fas fa-dollar-sign mr-2"></i>
                                <span>${{ tech.hourly_rate }}/hr</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex space-x-2">
                        {% if tech.availability_status == "Available" %}
                        <button class="flex-1 bg-gradient-to-r from-[#8fbaf3] to-[#0245a3] text-white font-semibold rounded-xl py-3 hover:opacity-90 transition request-assistance-btn"
                                data-technician-id="{{ tech.id }}"
                                data-technician-name="{{ tech.first_name|default:tech.username }} {{ tech.last_name|default:'' }}">
                            Request Help
                        </button>
                        <a href="{% url 'technician_detail' tech.id %}" class="px-4 bg-white/30 border border-[#8fbaf3] text-[#0245a3] font-semibold rounded-xl py-3 hover:bg-white/40 transition flex items-center justify-center">
                            <i class="fas fa-eye"></i>
                        </a>
                        {% else %}
                        <button class="flex-1 bg-gray-400 text-white font-semibold rounded-xl py-3 cursor-not-allowed" disabled>
                            Currently Unavailable
                        </button>
                        <a href="{% url 'technician_detail' tech.id %}" class="px-4 bg-white/30 border border-[#8fbaf3] text-[#0245a3] font-semibold rounded-xl py-3 hover:bg-white/40 transition flex items-center justify-center">
                            <i class="fas fa-eye"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-user-cog text-6xl text-[#8fbaf3] mb-4"></i>
                    <h3 class="text-xl font-bold text-[#0245a3] mb-2">No Technicians Found</h3>
                    <p class="text-[#0245a3] mb-4">Try adjusting your search criteria or check back later.</p>
                    <a href="{% url 'technician_directory' %}" class="bg-gradient-to-r from-[#8fbaf3] to-[#0245a3] text-white font-semibold rounded-xl px-6 py-3 hover:opacity-90 transition">
                        Clear Filters
                    </a>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if technicians %}
            <div class="flex justify-center mt-8">
                <div class="bg-white/20 backdrop-blur-lg rounded-xl border border-[#8fbaf3]/40 p-2 flex space-x-2">
                    <button class="w-10 h-10 flex items-center justify-center text-[#0245a3] rounded-lg hover:bg-[#8fbaf3]/30 transition">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="w-10 h-10 flex items-center justify-center bg-[#0245a3] text-white rounded-lg">1</button>
                    <button class="w-10 h-10 flex items-center justify-center text-[#0245a3] rounded-lg hover:bg-[#8fbaf3]/30 transition">2</button>
                    <button class="w-10 h-10 flex items-center justify-center text-[#0245a3] rounded-lg hover:bg-[#8fbaf3]/30 transition">3</button>
                    <button class="w-10 h-10 flex items-center justify-center text-[#0245a3] rounded-lg hover:bg-[#8fbaf3]/30 transition">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

 <!--Request Assistance Modal-->
<div id="assistanceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 relative">
        <button type="button" class="modal-close absolute top-4 right-4 text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
        </button>
        <h3 class="text-xl font-bold text-[#0245a3] mb-4">Request Assistance</h3>
        <form id="assistanceForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-[#0245a3] text-sm font-medium mb-2">Title</label>
                    <input type="text" name="title" class="w-full border border-[#8fbaf3] rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#0245a3]"
                           placeholder="Brief description of your issue" required>
                </div>
                <div>
                    <label class="block text-[#0245a3] text-sm font-medium mb-2">Description</label>
                    <textarea name="description" rows="4" class="w-full border border-[#8fbaf3] rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#0245a3]"
                              placeholder="Detailed description of your problem..." required></textarea>
                </div>
                <div>
                    <label class="block text-[#0245a3] text-sm font-medium mb-2">Priority</label>
                    <select name="priority" class="w-full border border-[#8fbaf3] rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#0245a3]">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
            </div>
            <div class="flex space-x-3 mt-6">
                <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 font-semibold rounded-xl py-3 hover:bg-gray-400 transition">
                    Cancel
                </button>
                <button type="submit" class="flex-1 bg-gradient-to-r from-[#8fbaf3] to-[#0245a3] text-white font-semibold rounded-xl py-3 hover:opacity-90 transition">
                    Send Request
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Modal system initializing...');

    // Remove any existing modal completely
    const existingModal = document.getElementById('assistanceModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Create clean modal HTML
    const modalHTML = `
        <div id="assistanceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;" class="hidden">
            <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 relative" style="z-index: 10001;">
                <button type="button" id="modalCloseBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-xl font-bold">
                    Ã—
                </button>
                <h3 class="text-xl font-bold text-[#0245a3] mb-4" id="modalTitle">Request Assistance</h3>
                <form id="assistanceForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[#0245a3] text-sm font-medium mb-2">Title</label>
                            <input type="text" name="title" class="w-full border border-[#8fbaf3] rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#0245a3]"
                                   placeholder="Brief description of your issue" required>
                        </div>
                        <div>
                            <label class="block text-[#0245a3] text-sm font-medium mb-2">Description</label>
                            <textarea name="description" rows="4" class="w-full border border-[#8fbaf3] rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#0245a3]"
                                      placeholder="Detailed description of your problem..." required></textarea>
                        </div>
                        <div>
                            <label class="block text-[#0245a3] text-sm font-medium mb-2">Priority</label>
                            <select name="priority" class="w-full border border-[#8fbaf3] rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#0245a3]">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex space-x-3 mt-6">
                        <button type="button" id="modalCancelBtn" class="flex-1 bg-gray-300 text-gray-700 font-semibold rounded-xl py-3 hover:bg-gray-400 transition">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 bg-gradient-to-r from-[#8fbaf3] to-[#0245a3] text-white font-semibold rounded-xl py-3 hover:opacity-90 transition">
                            Send Request
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Get fresh references
    const modal = document.getElementById('assistanceModal');
    const form = document.getElementById('assistanceForm');
    const closeBtn = document.getElementById('modalCloseBtn');
    const cancelBtn = document.getElementById('modalCancelBtn');

    let isModalOpen = false;

    // Modal control functions
    function openModal(techName, techId) {
        console.log('Opening modal for:', techName);

        // Update title
        const title = document.getElementById('modalTitle');
        if (title) {
            title.textContent = `Request Assistance from ${techName}`;
        }

        // Store technician ID
        if (form) {
            form.dataset.technicianId = techId;
        }

        // Show modal - using both methods for maximum compatibility
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        isModalOpen = true;

        console.log('Modal opened successfully');
    }

    function closeModal() {
        console.log('Closing modal');
        modal.classList.add('hidden');
        modal.style.display = 'none';
        document.body.style.overflow = '';
        if (form) form.reset();
        isModalOpen = false;

        // Clear any stored data
        if (form) {
            delete form.dataset.technicianId;
        }
    }

    // Make closeModal available globally
    window.closeModal = closeModal;

    // Event listeners with proper cleanup
    function setupEventListeners() {
        // Close button
        if (closeBtn) {
            closeBtn.onclick = closeModal;
        }

        // Cancel button
        if (cancelBtn) {
            cancelBtn.onclick = closeModal;
        }

        // Click outside to close - but only on the backdrop
        modal.onclick = function(e) {
            if (e.target === modal) {
                closeModal();
            }
        };

        // Escape key to close
        document.onkeydown = function(e) {
            if (e.key === 'Escape' && isModalOpen) {
                closeModal();
            }
        };

        // Form submission
        if (form) {
            form.onsubmit = function(e) {
                e.preventDefault();

                const technicianId = this.dataset.technicianId;
                if (!technicianId) {
                    alert('No technician selected');
                    return;
                }

                const formData = new FormData(this);
                const title = formData.get('title').trim();
                const description = formData.get('description').trim();

                if (!title || !description) {
                    alert('Please fill in all required fields');
                    return;
                }

                // Get CSRF token
                function getCSRFToken() {
                    return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                           document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
                }

                // Submit request
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Sending...';
                submitBtn.disabled = true;

                fetch('{% url "request_assistance" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        technician_id: technicianId,
                        title: title,
                        description: description,
                        priority: formData.get('priority')
                    })
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network error');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('Request sent successfully!');
                        closeModal();
                    } else {
                        throw new Error(data.error || 'Request failed');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error: ' + error.message);
                })
                .finally(() => {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                });
            };
        }

        // Request assistance buttons
        document.querySelectorAll('.request-assistance-btn').forEach(button => {
            button.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();

                const techId = this.getAttribute('data-technician-id');
                const techName = this.getAttribute('data-technician-name');

                if (techId && techName) {
                    openModal(techName, techId);
                }

                return false;
            };
        });
    }

    // Initialize event listeners
    setupEventListeners();

    console.log('Modal system ready');
});
</script>

<style>
    .animation-delay-2000 { animation-delay: 2s; }
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Modal styling - minimal and forceful */
    #assistanceModal {
        display: none !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: rgba(0, 0, 0, 0.5) !important;
        z-index: 10000 !important;
    }

    #assistanceModal:not(.hidden) {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
</style>
{% endblock %}